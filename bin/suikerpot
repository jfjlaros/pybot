#!/usr/bin/python

import datetime, re
from pybot import irclib, basicbot

def IsFriend(nick):
	if not getattr(nick, "mask", None):
		return 0

	try:
		for line in open('friends').readlines():
			words=re.split("\s",line.rstrip())
			if len(words)==0:
				continue
			
			if re.search("^%s$" % words[0], nick.mask):
				if len(words)==2:
					return int(words[1])
				return 1

	except IOError,x:
		print "Unable to open 'friends' file: ",x
	
	return 0



class SuikerPot(basicbot.BasicBot):
	PublicCommands	= { }

	def OnEndOfNames(self, connection, event):
		self.server.privmsg(event.arguments()[0],
				self.config["messages/startup"])

	
	def CmdSplit(msg):
		data=msg.split(None, 1)
		if not data:
			return ("", "")
		return data
	CmdSplit=staticmethod(CmdSplit)


	def OnPubMsg(self, connection, event):
		super(SuikerPot,self).OnPubMsg(connection, event)

		channel=event.target()
		(cmd,args)=self.CmdSplit(event.arguments()[0])

		func="PubCmd"+cmd[1:].capitalize()
		if cmd[0]=='!' and hasattr(self, func):
			nick=self.people[irclib.nm_to_n(event.source())]
			getattr(self, func)(channel, nick, args)


	def OnPrivMsg(self, connection, event):
		super(SuikerPot,self).OnPrivMsg(connection, event)

		(cmd,args)=self.CmdSplit(event.arguments()[0])
		func="PrivCmd"+cmd[1:].capitalize()
		if msg[0]=='!' and hasattr(self, func):
			nick=self.people[irclib.nm_to_n(event.source())]
			getattr(self, func)(nick, args)


	def OnJoin(self, connection, event):
		super(SuikerPot,self).OnJoin(connection, event)

		nick=irclib.nm_to_n(event.source())
		if nick==self.connection.get_nickname():  # this is us!
			self.logger.info("We finished joining %s ourselves" 
					% event.target())
			return 

		self.RegisterNick(event)
		if IsFriend(event.source()):
			self.logger.info("%s is a friend, giving ops" % nick)
			self.op(nick)
		else:
			self.logger.info("%s is not a friend, giving voice and sending welcome message" % nick)
			self.voice(nick)
			if self.CheckLimit():
				self.connection.notice(nick, self.config["messages/welcome"])
	

	def PubCmdKoffie(self, channel, nick, args):
		if self.CheckLimit():
			self.server.ctcp("ACTION", channel,
					self.config["messages/koffie"] % nick.nick)
	

	def PubCmdKlant(self, channel, nick, args):
		if self.CheckLimit():
			self.server.privmsg(channel,
					self.config["messages/klant"])
	

	def PubCmdSeen(self, channel, nick, args):
		prey=args.split(None, 1)
		if len(prey)!=1:
			self.server.privmsg(nick.nick, "Usage: !seen <nick>")
			return
		prey=prey[0]

		if self.CheckLimit():
			if prey not in self.people:
				self.server.privmsg(channel,
					"Never seen activity from %s" % prey)
			else:
				delta=datetime.datetime.now()-self.people[prey].seen
				x=delta.seconds
				(x, seconds)=(x/60, x%60)
				(x, minutes)=(x/60, x%60)
				hours=x
				days=delta.days
				
				msg=""
				for item in [ "days", "hours", "minutes"]:
					if locals()[item]:
						msg+=" %d %s" % (locals()[item], item)
				msg=msg.strip()

				if not msg:
					self.server.privmsg(channel,
						"%s is here right now!" % prey)
				else:
					self.server.privmsg(channel, 
						"Last seen %s %s ago" % (prey, msg))


	def PrivCmdSay(self, nick, args):
		if IsFriend(nick):
			try:
				(channel,msg)=args.split(None, 1)
				self.server.privmsg(channel, msg)
			except ValueError:
				self.server.privmsg(nick.nick,
						"Not enough parameters")

	def PrivCmdDo(self, nick, args):
		if IsFriend(nick):
			try:
				(channel,msg)=args.split(None, 1)
				self.server.ctcp("ACTION", channel, msg)
			except ValueError:
				self.server.privmsg(nick.nick,
						"Not enough parameters")

	def PrivCmdOp(self, nick, args):
		if IsFriend(nick)>1:
			self.server.privmsg(nick.nick, "You will be opped")
			self.op(nick.nick)
		else:
			self.server.privmsg(nick.nick, "Sorry, I do not trust you.")


if __name__ == "__main__":
	bot=SuikerPot()
	bot.MainLoop()

